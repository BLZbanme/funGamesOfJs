<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>贪吃蛇</title>
    <style>
      div {
        margin: 10px auto;
        display: flex;
        justify-content: center;
      }

      .button {
        justify-content: space-between;
        align-items: center;
      }

      .button a, .button span {
        font-size: 1.5rem;
      }

      .button a {
        border: 1px solid grey;
        border-radius: 15%;
        background:grey;
        color: white;
        cursor: pointer;
      }

      .button #restart {
        display: none;
      }

      .button p {
        margin-top: 0;
        margin-bottom: 0;
        background: gray;
        color: white;
        border-radius: 8%;
      }

    </style>
  </head>

  <body>
    <div class='canvas'>
      <canvas></canvas>
    </div>
    <div class="button">
      <a id="start">start</a>
      <a id="restart">restart</a>
      <span id="help">点击start开始游戏</span>
      <p>
        <span>scores:</span>
        <span id="scores">0</span>
      </p>
    </div>
    
    <script>
      let scores = 0;
      const canvas = document.querySelector('canvas');
      const div = document.querySelector('.canvas');
      const ctx = canvas.getContext('2d');
      const size = 20;
      const width = canvas.width = getGoodPoint(window.innerWidth * .6);
      const height = div.style.height = canvas.height = getGoodPoint(window.innerHeight * .6);
      div.style.width = width + "px";
      div.style.height = height + "px";
      const buttondiv = document.querySelector(".button");
      buttondiv.style.width = width + "px";
      drawBorder();

      function Snake(x, y, length, v, dir){
        this.body = getBodyArr(x, y, length, dir);
        this.v = v;
        this.dir = dir;
        this.alive = true;
      }

      function getGoodPoint(length){
        return parseInt(length / size) * size;
      }

      function drawBorder(){
        ctx.beginPath();
        ctx.fillStyle = "black";
        ctx.strokeRect(0, 0, width, height);
      }

      function getBodyArr(x, y, length, dir){
        let body = [];
        for(let i = 0; i < length; i++){
          switch(dir){
            case "right":
              body.push([x - i * size, y]);
              break;
            case "left":
              body.push([x + i * size, y]);
              break;
            case "top":
              body.push([x, y + i * size]);
              break;
            case "down":
              body.push([x, y - i * size]);
              break;
            default:
              body.push([x - i * size, y]);
              break;
          }
        }
        return body;
      }

      Snake.prototype.draw = function(){
        ctx.beginPath();
        ctx.fillStyle = "red";
        for(let e of this.body){
          ctx.fillRect(e[0], e[1], size, size);
        }
      }

      Snake.prototype.move = function(){
        let body = this.body;
        let v = this.v;
        for(let i = body.length - 1; i > 0; i--){
          body[i][0] = body[i - 1][0];
          body[i][1] = body[i - 1][1];
        }
        switch(this.dir){
          case "right":
              body[0][0] += size * v;
              break;
            case "left":
              body[0][0] -= size * v;
              break;
            case "top":
              body[0][1] -= size * v;
              break;
            case "down":
              body[0][1] += size * v;
              break;
        }
        this.alive = !isDeadSnake(body);
        if((food != undefined || food != null) && body[0][0] == food.x && body[0][1] == food.y){
          this.eat();
        }
      }

      Snake.prototype.eat = function(){
        food = null;
        let addBody = [];
        let body = this.body;
        let end = body.length - 1;
        switch(this.dir){
          case "right":
              addBody[0] = body[end][0] - size;
              addBody[1] = body[end][1];
              break;
            case "left":
              addBody[0] = body[end][0] + size;
              addBody[1] = body[end][1];
              break;
            case "top":
              addBody[0] = body[end][0];
              addBody[1] = body[end][1] + size;
              break;
            case "down":
              addBody[0] = body[end][0];
              addBody[1] = body[end][1] + size;
              break;
        }
        body.push(addBody);
        scores++;
      }

      function isDeadSnake(body){
        return body[0][0] < 0 || body[0][0] > width || body[0][1] < 0 || body[0][1] > height;
      }

      function Food(x, y){
        this.x = x;
        this.y = y;
      }

      Food.prototype.draw = function(){
        ctx.fillStyle = "green";
        ctx.fillRect(this.x, this.y, size, size);
      }

      function creatSnake(){
        snake = new Snake(parseInt(width / 2), parseInt(height / 2), 3, 1, "right");
        snake.draw();
      }

      function creatFood(){
        let x = parseInt(width * Math.random() / size) * size;
        let y = parseInt(height * Math.random() / size) * size;
        food = new Food(x, y);
        food.draw();
      }

      var snake;
      var food;
      
      creatSnake();
      creatFood();
      

      function loop(){
        if(!snake.alive){
          alert("you dead");
          document.querySelector("#start").style.display = "none";
          document.querySelector("#restart").style.display = "inline";
          document.querySelector("#help").innerHTML = "点击restart重新开始游戏";
          return;
        }
        ctx.clearRect(0, 0, width, height);
        drawBorder();
        snake.draw();
        snake.move();
        if(food == undefined || food == null){
          creatFood();
        }
        food.draw();
        document.querySelector("#scores").innerHTML = scores;
        requestAnimationFrame(loop);
      };
      
      var start = document.querySelector("#start");

      start.onclick = function(){
        window.onkeydown = function(e){
         switch(e.key){
          case "ArrowLeft":
            snake.dir = snake.dir != "right" ? "left" : "right";
            break;
          case "ArrowRight":
            snake.dir = snake.dir != "left" ? "right" : "left";
            break;
          case "ArrowUp":
            snake.dir = snake.dir != "down" ? "top" : "down";
            break;
          case "ArrowDown":
            snake.dir = snake.dir != "top" ? "down" : "top";
            break;
         }
       }
       loop();
      }

      var restart = document.querySelector("#restart");

      restart.onclick = function(){
        ctx.clearRect(0, 0, width, height);
        drawBorder();
        creatSnake();
        creatFood();
        document.querySelector("#start").style.display = "inline";
        document.querySelector("#restart").style.display = "none";
        document.querySelector("#help").innerHTML = "点击start开始游戏";
      }
      
    </script>
  </body>
</html>